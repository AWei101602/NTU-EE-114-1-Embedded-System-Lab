<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentry è—ç‰™ç›£æ§æ§åˆ¶å™¨ v3 (ç©©å®šç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #007AFF;
            --success-color: #34C759;
            --danger-color: #FF3B30;
            --warning-color: #FF9500;
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-color: #1C1C1E;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            padding: 30px 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            text-align: center;
        }

        h1 {
            margin-top: 0;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #8E8E93;
            font-size: 0.9rem;
            margin-bottom: 25px;
        }

        /* ç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
        .status-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 0 auto 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-circle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background-color: #E5E5EA;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: inset 0 5px 10px rgba(0,0,0,0.05);
            z-index: 2;
        }

        .status-circle i {
            font-size: 2.5rem;
            margin-bottom: 5px;
            font-style: normal;
        }

        .status-label {
            font-size: 1.2rem;
            font-weight: 700;
            color: #8E8E93;
        }

        /* ç‹€æ…‹æ³¢ç´‹å‹•ç•« */
        .ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background-color: transparent;
            z-index: 1;
        }

        /* ç‹€æ…‹æ¨£å¼ */
        .status-circle.active {
            background-color: var(--success-color);
            box-shadow: 0 10px 20px rgba(52, 199, 89, 0.3);
        }
        .status-circle.active .status-label,
        .status-circle.active i { color: white; }

        .status-circle.alert {
            background-color: var(--danger-color);
            box-shadow: 0 10px 20px rgba(255, 59, 48, 0.4);
            animation: shake 0.5s ease-in-out;
        }
        .status-circle.alert .status-label,
        .status-circle.alert i { color: white; }
        
        .status-circle.alert + .ripple {
            animation: ripple-effect 1.5s infinite;
            background-color: rgba(255, 59, 48, 0.3);
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background-color: #F2F2F7;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #3A3A3C;
        }
        .info-value { font-weight: 600; }

        /* æŒ‰éˆ• */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
        }

        .btn-toggle {
            background-color: #D1D1D6;
            color: #8E8E93;
            cursor: not-allowed;
        }
        
        .btn-toggle.enabled {
            background-color: var(--success-color);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3);
        }

        .btn-toggle.enabled.armed {
            background-color: var(--warning-color);
            box-shadow: 0 4px 10px rgba(255, 149, 0, 0.3);
        }
        
        .mode-switch {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #666;
            gap: 8px;
        }

        .log-area {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 8px;
            text-align: left;
            font-size: 12px;
            height: 100px;
            overflow-y: auto;
            margin-top: 20px;
            display: block; /* V3 æ”¹ç‚ºé è¨­é¡¯ç¤ºï¼Œæ–¹ä¾¿é™¤éŒ¯ */
        }

        @keyframes ripple-effect {
            0% { width: 140px; height: 140px; opacity: 0.8; }
            100% { width: 240px; height: 240px; opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .setup-hint {
            font-size: 0.8rem;
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: left;
            display: block;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Sentry ç›£æ§ä¸­å¿ƒ</h1>
    <div class="subtitle">BLE é ç«¯å®‰å…¨ç³»çµ± v3 (ç©©å®šç‰ˆ)</div>

    <!-- æç¤ºä½¿ç”¨è€… -->
    <div class="setup-hint" id="uuidHint">
        <strong>âš ï¸ é€£ç·šå¤±æ•—æ€éº¼è¾¦ï¼Ÿ</strong><br>
        1. æŒ‰ä¸€ä¸‹é–‹ç™¼æ¿çš„é»‘è‰² <strong>RESET</strong> æŒ‰éˆ•ã€‚<br>
        2. é—œé–‰æ‰‹æ©Ÿä¸Šçš„ nRF Connect App (é¿å…ä½”ç”¨)ã€‚<br>
        3. é‡æ–°é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€£ç·šã€‚
    </div>

    <div class="status-container">
        <div id="statusCircle" class="status-circle">
            <i id="statusIcon">ğŸ”’</i>
            <span id="statusText" class="status-label">å¾…æ©Ÿ</span>
        </div>
        <div class="ripple"></div>
    </div>

    <div class="control-panel">
        <div class="info-row">
            <span>é€£ç·šç‹€æ…‹</span>
            <span id="connectionState" class="info-value" style="color: #FF3B30">æœªé€£ç·š</span>
        </div>
        <div class="info-row">
            <span>ç³»çµ±æ¨¡å¼</span>
            <span id="systemMode" class="info-value">--</span>
        </div>
        <div class="info-row">
            <span>æ„Ÿæ¸¬å™¨ç‹€æ…‹</span>
            <span id="sensorState" class="info-value">--</span>
        </div>
    </div>
    
    <!-- æœå°‹æ¨¡å¼é¸é … -->
    <div class="mode-switch">
        <label>
            <input type="checkbox" id="chkShowAll"> é¡¯ç¤ºæ‰€æœ‰è£ç½® (è‹¥æœä¸åˆ°è«‹å‹¾é¸)
        </label>
    </div>

    <button id="btnConnect" class="btn btn-primary" style="margin-bottom: 15px;">
        ğŸ” æœå°‹ä¸¦é€£ç·š
    </button>

    <button id="btnToggle" class="btn btn-toggle" disabled>
        ğŸ›¡ï¸ é–‹å•Ÿè­¦æˆ’æ¨¡å¼
    </button>

    <div id="logArea" class="log-area"></div>
    <div style="margin-top:10px; font-size: 12px; color: #aaa; cursor: pointer;" onclick="toggleLog()">
        [ é¡¯ç¤º/éš±è—é™¤éŒ¯æ—¥èªŒ ]
    </div>
</div>

<script>
    // =================================================================
    // UUID è¨­å®š
    // =================================================================
    const SERVICE_UUID     = "1bc5d5a5-0200-b49a-e111-010000000000"; 
    const CHAR_CTRL_UUID   = "1bc5d5a5-0200-b49a-e111-020000000000"; 
    const CHAR_STATUS_UUID = "1bc5d5a5-0200-b49a-e111-030000000000"; 
    
    // è£ç½®åç¨±
    const TARGET_DEVICE_NAME = "Sentry";
    // =================================================================

    // è®Šæ•¸
    let device, server, service;
    let ctrlChar, statusChar;
    let isConnected = false;
    let isArmed = false;

    // UI å…ƒç´ 
    const btnConnect = document.getElementById('btnConnect');
    const btnToggle = document.getElementById('btnToggle');
    const chkShowAll = document.getElementById('chkShowAll');
    const statusCircle = document.getElementById('statusCircle');
    const statusText = document.getElementById('statusText');
    const statusIcon = document.getElementById('statusIcon');
    const connectionState = document.getElementById('connectionState');
    const systemMode = document.getElementById('systemMode');
    const sensorState = document.getElementById('sensorState');
    const logArea = document.getElementById('logArea');
    const uuidHint = document.getElementById('uuidHint');

    function log(msg) {
        const time = new Date().toLocaleTimeString();
        logArea.innerHTML += `[${time}] ${msg}<br>`;
        logArea.scrollTop = logArea.scrollHeight;
        console.log(msg);
    }

    function toggleLog() {
        logArea.style.display = logArea.style.display === 'none' ? 'block' : 'none';
    }

    // è¼”åŠ©å‡½å¼ï¼šå»¶é²
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // 1. é€£ç·šé‚è¼¯
    btnConnect.addEventListener('click', async () => {
        if (isConnected) {
            disconnect();
            return;
        }

        try {
            log('æº–å‚™æœå°‹è£ç½®...');
            
            let options = {
                optionalServices: [SERVICE_UUID] 
            };

            if (chkShowAll.checked) {
                log('ä½¿ç”¨å¯¬é¬†æ¨¡å¼ (acceptAllDevices)');
                options.acceptAllDevices = true;
            } else {
                log(`æœå°‹åç¨±: ${TARGET_DEVICE_NAME}`);
                options.filters = [{ name: TARGET_DEVICE_NAME }];
            }

            // A. è«‹æ±‚è£ç½®
            device = await navigator.bluetooth.requestDevice(options);

            device.addEventListener('gattserverdisconnected', onDisconnected);
            
            connectionState.innerText = "é€£ç·šä¸­...";
            log(`é¸å®šè£ç½®: ${device.name}`);

            // B. å˜—è©¦é€£ç·š
            log('æ­£åœ¨å»ºç«‹ GATT é€£ç·š...');
            server = await device.gatt.connect();
            log('GATT é€£ç·šæˆåŠŸï¼');
            
            // ã€é—œéµä¿®æ”¹ã€‘å¢åŠ å»¶é²ï¼Œè®“è—ç‰™å †ç–Šç©©å®šä¸‹ä¾†
            log('ç­‰å¾…é€šè¨Šç©©å®š (1ç§’)...');
            await sleep(1000);

            // C. å–å¾— Service
            log('æ­£åœ¨è®€å– Service...');
            try {
                service = await server.getPrimaryService(SERVICE_UUID);
                log('Service è®€å–æˆåŠŸ');
            } catch (err) {
                log('âŒ Service è®€å–å¤±æ•—ã€‚å¯èƒ½æ˜¯ UUID ä¸åŒ¹é…æˆ–è£ç½®å¿™ç¢Œã€‚');
                log('éŒ¯èª¤è©³æƒ…: ' + err);
                throw err;
            }

            // D. å–å¾— Characteristics
            log('æ­£åœ¨è®€å– Characteristics...');
            ctrlChar = await service.getCharacteristic(CHAR_CTRL_UUID);
            statusChar = await service.getCharacteristic(CHAR_STATUS_UUID);
            
            // E. è¨‚é–± Notify
            log('æ­£åœ¨è¨‚é–±é€šçŸ¥...');
            await statusChar.startNotifications();
            statusChar.addEventListener('characteristicvaluechanged', handleNotifications);
            log('âœ… å…¨éƒ¨å°±ç·’ï¼');

            // æ›´æ–° UI ç‹€æ…‹
            onConnected();

        } catch (error) {
            log('âŒ éŒ¯èª¤ä¸­æ­¢: ' + error);
            
            let errorMsg = error.toString();
            if (errorMsg.includes("cancelled")) {
                connectionState.innerText = "ä½¿ç”¨è€…å–æ¶ˆ";
            } else if (errorMsg.includes("Connection failed")) {
                alert('é€£ç·šå¤±æ•—ï¼\n\nè«‹å‹™å¿…æŒ‰ä¸€ä¸‹é–‹ç™¼æ¿çš„ã€ŒRESET æŒ‰éˆ•ã€å¾Œå†è©¦ä¸€æ¬¡ã€‚\n(èˆŠçš„é€£ç·šå¯èƒ½å¡ä½äº†)');
                connectionState.innerText = "é€£ç·šå¤±æ•—";
            } else {
                alert('ç™¼ç”ŸéŒ¯èª¤:\n' + error);
                connectionState.innerText = "é€£ç·šå¤±æ•—";
            }
            connectionState.style.color = "#FF3B30";
        }
    });

    // 2. è™•ç† Notify (è­¦å ±)
    function handleNotifications(event) {
        const value = event.target.value;
        const alertStatus = value.getUint8(0); // è®€å–ç¬¬ä¸€å€‹ byte

        log(`æ”¶åˆ° Notify: ${alertStatus}`);

        if (alertStatus === 1) {
            statusCircle.className = "status-circle alert";
            statusText.innerText = "å…¥ä¾µè­¦å ±";
            statusIcon.innerText = "âš ï¸";
            sensorState.innerText = "åµæ¸¬åˆ°ç‰©é«”";
            sensorState.style.color = "#FF3B30";
            
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
        } else {
            if (isArmed) {
                statusCircle.className = "status-circle active";
                statusText.innerText = "ç›£æ§ä¸­";
                statusIcon.innerText = "ğŸ›¡ï¸";
            } else {
                statusCircle.className = "status-circle";
                statusText.innerText = "å¾…æ©Ÿ";
                statusIcon.innerText = "ğŸ”’";
            }
            sensorState.innerText = "å€åŸŸå®‰å…¨";
            sensorState.style.color = "#34C759";
        }
    }

    // 3. åˆ‡æ›æ¨¡å¼ (Write)
    btnToggle.addEventListener('click', async () => {
        if (!ctrlChar) return;

        try {
            const targetState = !isArmed;
            const data = new Uint8Array([targetState ? 1 : 0]);
            
            log(`å¯«å…¥æ¨¡å¼: ${targetState ? 'ON (0x01)' : 'OFF (0x00)'}`);
            await ctrlChar.writeValue(data);
            
            isArmed = targetState;
            updateArmUI();

        } catch (error) {
            log('å¯«å…¥å¤±æ•—: ' + error);
            alert('æŒ‡ä»¤ç™¼é€å¤±æ•—ï¼Œå¯èƒ½å·²æ–·ç·š');
            disconnect();
        }
    });

    function updateArmUI() {
        if (isArmed) {
            btnToggle.innerHTML = "ğŸ›‘ é—œé–‰è­¦æˆ’æ¨¡å¼";
            btnToggle.classList.add('armed');
            
            statusCircle.className = "status-circle active";
            statusText.innerText = "ç›£æ§ä¸­";
            statusIcon.innerText = "ğŸ›¡ï¸";
            
            systemMode.innerText = "è­¦æˆ’æ¨¡å¼ (ON)";
            systemMode.style.color = "#FF9500";
        } else {
            btnToggle.innerHTML = "ğŸ›¡ï¸ é–‹å•Ÿè­¦æˆ’æ¨¡å¼";
            btnToggle.classList.remove('armed');
            
            statusCircle.className = "status-circle";
            statusText.innerText = "å¾…æ©Ÿ";
            statusIcon.innerText = "ğŸ”’";
            
            systemMode.innerText = "å¾…æ©Ÿæ¨¡å¼ (OFF)";
            systemMode.style.color = "#8E8E93";
            
            sensorState.innerText = "--";
            sensorState.style.color = "";
        }
    }

    function onConnected() {
        isConnected = true;
        uuidHint.style.display = 'none'; 
        connectionState.innerText = "å·²é€£ç·š";
        connectionState.style.color = "#34C759";
        
        btnConnect.innerText = "âŒ æ–·é–‹é€£ç·š";
        btnConnect.classList.remove('btn-primary');
        btnConnect.style.backgroundColor = "#E5E5EA";
        btnConnect.style.color = "#FF3B30";
        
        btnToggle.disabled = false;
        btnToggle.classList.add('enabled');
        
        isArmed = false;
        updateArmUI();
    }

    function onDisconnected() {
        log('è£ç½®å·²æ–·ç·š');
        disconnect(); 
    }

    function disconnect() {
        if (device && device.gatt.connected) {
            device.gatt.disconnect();
        }
        
        isConnected = false;
        isArmed = false;
        
        connectionState.innerText = "æœªé€£ç·š";
        connectionState.style.color = "#FF3B30";
        
        btnConnect.innerText = "ğŸ” æœå°‹ä¸¦é€£ç·š";
        btnConnect.classList.add('btn-primary');
        btnConnect.style.backgroundColor = "";
        btnConnect.style.color = "";
        
        btnToggle.disabled = true;
        btnToggle.classList.remove('enabled', 'armed');
        btnToggle.innerHTML = "ğŸ›¡ï¸ é–‹å•Ÿè­¦æˆ’æ¨¡å¼";
        
        statusCircle.className = "status-circle";
        statusText.innerText = "å¾…æ©Ÿ";
        statusIcon.innerText = "ğŸ”’";
        
        systemMode.innerText = "--";
        sensorState.innerText = "--";
    }
</script>

</body>
</html>